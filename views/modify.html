<!doctype html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		  content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>BD Ugo - Modification</title>
	<style>
		body {
			background-color: black;
			margin: 0;
			padding: 0;
			min-height: 1000vh;
			position: relative;
		}
		img {
			border: 5px solid white;
			transform: translate3D(0, 0, 0);
			transition: 0s;
			position: absolute;
			top: 0;
			left: 0;
			z-index: 0;
		}
		.active {
			z-index: 999;
		}
	</style>
</head>
<body>
<script>
	const active = require('../bds/active.json')
	const interact = require('interactjs')
	const _ = require('underscore')
	const bd = require('../bds/' + active.active + '/' + active.active + '.json')
	let html = document.querySelector('html')
	let items = []
	let startPosition = null
	bd.forEach((image) => {
		let el = document.createElement("img")
		el.src = image.url
		el.classList.add('img')
		el.style.transform = `translate3d(${image.x}, ${image.y}, 0)`
		el.style.width = image.width
		el.style.height = image.height
		document.body.appendChild(el)
		items.push(el)
	})

	const move = _.throttle((e) => {
		let x = startPosition.x + e.clientX - e.clientX0 + html.scrollLeft
		let y = startPosition.y + e.clientY - e.clientY0 + html.scrollTop
		e.target.style.transform = `translate3D(${x}px, ${y}px, 0)`
	}, 16)

	const resize = _.throttle((e) => {
		let target = e.target
		target.style.width = e.rect.width + 'px'
		target.style.height = e.rect.height + 'px'
	}, 16)

	const interactionStart = (e) => {
		e.target.classList.add('active')
		let rect = e.target.getBoundingClientRect()
		startPosition = {
			x: rect.x,
			y: rect.y,
		}
	}

	function getTransform(el) {
		let results = window.getComputedStyle(el).transform.match(/matrix(?:(3d)\(\d+(?:, \d+)*(?:, (\d+))(?:, (\d+))(?:, (\d+)), \d+\)|\(\d+(?:, \d+)*(?:, (\d+))(?:, (\d+))\))/)

		if(!results) return [0, 0, 0];
		if(results[1] == '3d') return results.slice(2,5);

		results.push(0);
		return results.slice(5, 8);
	}

	interact('img')
		.origin('self')
		.draggable({
			inertia: false,
			autoScroll: true,
			onmove: move,
			onstart: interactionStart,
			onend: (e) => {
				let t = e.target
				let pos = getTransform(t)
				let y = parseInt(pos[1])
				let x = parseInt(pos[0])
				let zIndex = parseInt(t.style.zIndex) || 0
				items.forEach((item) => {
					if(item.src !== t.src)
					{
						let ipos = getTransform(item)
						let iy = parseInt(ipos[1])
						let ix = parseInt(ipos[0])
						// Collision
						if(x < ix + item.offsetWidth &&
						x + t.offsetWidth > ix &&
						y < iy + item.offsetHeight &&
						y + t.offsetHeight > iy)
						{
							let itemIndex = parseInt(item.style.zIndex) || 0
							if(zIndex <= itemIndex)
							{
								t.style.zIndex = "" + (itemIndex + 1)
								zIndex = (itemIndex + 1)
							}
						}
					}
				})
				e.target.classList.remove('active')
			}
		})
		.resizable({
			edges: {right: true, bottom: true},
			inertia: false,
			onmove: resize,
			onstart: interactionStart
		})

</script>
</body>
</html>